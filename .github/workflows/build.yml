name: Build and Release L2 Setup

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x
    
    - name: Restore dependencies
      run: dotnet restore src/WindowsSetup.App/WindowsSetup.App.csproj
    
    - name: Build
      run: dotnet build src/WindowsSetup.App/WindowsSetup.App.csproj --configuration Release --no-restore
    
    - name: Publish Self-Contained Executable
      run: |
        dotnet publish src/WindowsSetup.App/WindowsSetup.App.csproj `
          --configuration Release `
          --runtime win-x64 `
          --self-contained true `
          --output Release `
          /p:PublishSingleFile=true `
          /p:IncludeNativeLibrariesForSelfExtract=true `
          /p:EnableCompressionInSingleFile=true

    - name: Verify Build Output
      run: |
        Write-Host "=== Build Output Contents ===" -ForegroundColor Cyan
        Get-ChildItem -Path Release -Recurse | Format-Table Name, Length
        if (Test-Path "Release/L2Setup.exe") {
          Write-Host "âœ… L2Setup.exe found!" -ForegroundColor Green
          $size = (Get-Item "Release/L2Setup.exe").Length / 1MB
          Write-Host "Size: $([math]::Round($size, 2)) MB" -ForegroundColor Yellow
        } else {
          Write-Host "âŒ L2Setup.exe NOT FOUND!" -ForegroundColor Red
          exit 1
        }

    - name: Upload Build Artifact
      uses: actions/upload-artifact@v4
      with:
        name: L2Setup-Executable
        path: Release/L2Setup.exe
        if-no-files-found: error
        retention-days: 90

  create-installer:
    needs: build
    runs-on: windows-latest
    if: startsWith(github.ref, 'refs/tags/v') || startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Download Build Artifact
      uses: actions/download-artifact@v4
      with:
        name: L2Setup-Executable
        path: Release

    - name: Verify Downloaded Artifact
      run: |
        Write-Host "=== Downloaded Artifacts ===" -ForegroundColor Cyan
        if (Test-Path "Release") {
          Get-ChildItem -Path Release -Recurse | Format-Table Name, Length
        }
        if (Test-Path "Release/L2Setup.exe") {
          Write-Host "âœ… L2Setup.exe downloaded successfully!" -ForegroundColor Green
          $size = (Get-Item "Release/L2Setup.exe").Length / 1MB
          Write-Host "Size: $([math]::Round($size, 2)) MB" -ForegroundColor Yellow
        } else {
          Write-Host "âŒ L2Setup.exe NOT FOUND after download!" -ForegroundColor Red
          Write-Host "Contents of Release directory:" -ForegroundColor Yellow
          if (Test-Path "Release") {
            Get-ChildItem -Path Release -Recurse | Format-List
          }
          exit 1
        }

    - name: Setup Chocolatey
      shell: pwsh
      run: |
        Write-Host "Setting up Chocolatey..." -ForegroundColor Cyan
        Set-ExecutionPolicy Bypass -Scope Process -Force
        [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
        if (-not (Get-Command choco -ErrorAction SilentlyContinue)) {
          Write-Host "Installing Chocolatey..." -ForegroundColor Yellow
          iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
        }
        choco --version

    - name: Setup Inno Setup
      shell: pwsh
      run: |
        Write-Host "Installing Inno Setup 6..." -ForegroundColor Cyan
        choco install innosetup -y --version=6.2.2
        if ($LASTEXITCODE -ne 0) {
          Write-Host "âŒ Failed to install Inno Setup" -ForegroundColor Red
          exit 1
        }
        Write-Host "âœ… Inno Setup installed!" -ForegroundColor Green

    - name: Verify Inno Setup Installation
      shell: pwsh
      run: |
        $isccPath = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
        if (Test-Path $isccPath) {
          Write-Host "âœ… ISCC.exe found at $isccPath" -ForegroundColor Green
          & $isccPath /?
        } else {
          Write-Host "âŒ ISCC.exe not found at $isccPath" -ForegroundColor Red
          Write-Host "Searching for ISCC.exe..." -ForegroundColor Yellow
          Get-ChildItem -Path "C:\Program Files*" -Filter "ISCC.exe" -Recurse -ErrorAction SilentlyContinue | Select-Object FullName
          exit 1
        }

    - name: Create Installer
      shell: pwsh
      run: |
        $isccPath = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
        Write-Host "Creating installer with Inno Setup..." -ForegroundColor Cyan
        Write-Host "Working directory: $(Get-Location)" -ForegroundColor Yellow
        Write-Host "Setup.iss exists: $(Test-Path 'setup.iss')" -ForegroundColor Yellow
        Write-Host "Release/L2Setup.exe exists: $(Test-Path 'Release/L2Setup.exe')" -ForegroundColor Yellow
        
        & $isccPath setup.iss
        $exitCode = $LASTEXITCODE
        if ($exitCode -ne 0) {
          Write-Host "âŒ Installer creation failed with exit code $exitCode" -ForegroundColor Red
          exit 1
        }
        Write-Host "âœ… Installer created successfully!" -ForegroundColor Green

    - name: Verify Installer Output
      shell: pwsh
      run: |
        Write-Host "=== Installer Output Verification ===" -ForegroundColor Cyan
        Write-Host "Checking Release directory..." -ForegroundColor Yellow
        if (Test-Path "Release") {
          Write-Host "Release directory contents:" -ForegroundColor Cyan
          Get-ChildItem -Path Release -Filter "*.exe" | Format-Table Name, Length, LastWriteTime
          
          $installer = Get-ChildItem -Path Release -Filter "L2Setup-Installer.exe" | Select-Object -First 1
          if ($installer) {
            Write-Host "âœ… Installer found: $($installer.Name)" -ForegroundColor Green
            $size = $installer.Length / 1MB
            Write-Host "Size: $([math]::Round($size, 2)) MB" -ForegroundColor Yellow
            Write-Host "Full path: $($installer.FullName)" -ForegroundColor Cyan
          } else {
            Write-Host "âŒ L2Setup-Installer.exe NOT FOUND in Release directory!" -ForegroundColor Red
            Write-Host "Available .exe files:" -ForegroundColor Yellow
            Get-ChildItem -Path Release -Filter "*.exe" | Format-List Name, FullName
            exit 1
          }
        } else {
          Write-Host "âŒ Release directory not found!" -ForegroundColor Red
          exit 1
        }

    - name: Upload Installer Artifact
      uses: actions/upload-artifact@v4
      with:
        name: L2Setup-Installer
        path: Release/L2Setup-Installer.exe
        if-no-files-found: error
        retention-days: 90

  create-release:
    needs: [build, create-installer]
    runs-on: windows-latest
    if: startsWith(github.ref, 'refs/tags/v') || startsWith(github.ref, 'refs/tags/')

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Verify Tag
      shell: pwsh
      run: |
        $tag = "${{ github.ref_name }}"
        Write-Host "Tag: $tag" -ForegroundColor Cyan
        Write-Host "Ref: ${{ github.ref }}" -ForegroundColor Cyan
        
        # Check if tag exists locally
        git fetch --tags
        $tags = git tag -l
        Write-Host "Available tags:" -ForegroundColor Yellow
        $tags | ForEach-Object { Write-Host "  - $_" }
        
        if ($tags -contains $tag) {
          Write-Host "âœ… Tag $tag exists" -ForegroundColor Green
        } else {
          Write-Host "âš ï¸  Tag $tag not found in local repository" -ForegroundColor Yellow
          Write-Host "This might be normal if the tag was just pushed" -ForegroundColor Yellow
        }

    - name: Download Executable Artifact
      uses: actions/download-artifact@v4
      with:
        name: L2Setup-Executable
        path: artifacts/executable

    - name: Download Installer Artifact
      uses: actions/download-artifact@v4
      with:
        name: L2Setup-Installer
        path: artifacts/installer

    - name: Verify Downloaded Artifacts
      shell: pwsh
      run: |
        Write-Host "=== Verifying Downloaded Artifacts ===" -ForegroundColor Cyan
        
        if (Test-Path "artifacts/executable/L2Setup.exe") {
          $size = (Get-Item "artifacts/executable/L2Setup.exe").Length / 1MB
          Write-Host "âœ… Executable found: $([math]::Round($size, 2)) MB" -ForegroundColor Green
        } else {
          Write-Host "âŒ Executable NOT FOUND!" -ForegroundColor Red
          exit 1
        }
        
        if (Test-Path "artifacts/installer/L2Setup-Installer.exe") {
          $size = (Get-Item "artifacts/installer/L2Setup-Installer.exe").Length / 1MB
          Write-Host "âœ… Installer found: $([math]::Round($size, 2)) MB" -ForegroundColor Green
        } else {
          Write-Host "âŒ Installer NOT FOUND!" -ForegroundColor Red
          Write-Host "Contents of artifacts/installer:" -ForegroundColor Yellow
          if (Test-Path "artifacts/installer") {
            Get-ChildItem -Path "artifacts/installer" -Recurse | Format-List
          }
          exit 1
        }

    - name: Prepare Release Assets
      shell: pwsh
      run: |
        Write-Host "=== Preparing Release Assets ===" -ForegroundColor Cyan
        New-Item -ItemType Directory -Force -Path release-assets | Out-Null
        
        # Copy and rename with version
        $version = "${{ github.ref_name }}"
        Write-Host "Version: $version" -ForegroundColor Cyan
        
        Copy-Item "artifacts/executable/L2Setup.exe" "release-assets/L2Setup-$version.exe" -Force
        Copy-Item "artifacts/installer/L2Setup-Installer.exe" "release-assets/L2Setup-Installer-$version.exe" -Force
        
        Write-Host "âœ… Release assets prepared:" -ForegroundColor Green
        Get-ChildItem -Path release-assets | Format-Table Name, Length, LastWriteTime
        
        # Verify files exist
        if (-not (Test-Path "release-assets/L2Setup-$version.exe")) {
          Write-Host "âŒ Failed to copy executable!" -ForegroundColor Red
          exit 1
        }
        if (-not (Test-Path "release-assets/L2Setup-Installer-$version.exe")) {
          Write-Host "âŒ Failed to copy installer!" -ForegroundColor Red
          exit 1
        }

    - name: Get Version
      id: version
      shell: pwsh
      run: |
        $version = "${{ github.ref_name }}" -replace '^v', ''
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        Write-Host "Version: $version" -ForegroundColor Cyan

    - name: Generate Release Notes
      id: release_notes
      run: |
        $version = "${{ steps.version.outputs.VERSION }}"
        $notes = @"
        # ğŸš€ L2 Setup v$version

        ## ğŸ“¥ Downloads

        | File | Description | Size |
        |------|-------------|------|
        | **L2Setup-Installer-$version.exe** | ğŸ¯ **Recommended** - Includes .NET 8 auto-installer | ~49 MB |
        | **L2Setup-$version.exe** | Standalone executable (requires .NET 8) | ~166 MB |

        ## âœ¨ What's New

        See [CHANGELOG.md](https://github.com/theDAVIDL2/L2-Setup/blob/main/CHANGELOG.md) for detailed changes.

        ## ğŸ¯ Features

        - âœ… **50+ Windows Optimizations** (Performance, Privacy, Gaming, Network, Debloat)
        - âœ… **44+ Development Tools** Installation (Git, Python, Node.js, VS Code, etc.)
        - âœ… **30+ Runtimes** (VC++, .NET, DirectX, Java, OpenAL)
        - âœ… **Browser Profile Backup/Restore** (Brave, Chrome, Edge, Firefox)
        - âœ… **GPU Driver Auto-Detection** (NVIDIA, AMD, Intel)
        - âœ… **Windows Activation** (MAS integration)
        - âœ… **Material Design UI** with modern interface

        ## ğŸ“‹ Requirements

        - **OS**: Windows 10 (1809+) or Windows 11
        - **RAM**: 4 GB minimum (8 GB recommended)
        - **Storage**: 10 GB free space
        - **Internet**: Required for downloads
        - **.NET**: 8.0 Runtime (auto-installed by installer)

        ## ğŸš€ Quick Start

        ### After Formatting:
        1. Download **L2Setup-Installer-$version.exe**
        2. Run as Administrator
        3. Follow the wizard
        4. Enjoy your optimized system!

        ### Before Formatting:
        1. Launch L2 Setup
        2. Go to "Browser Management" tab
        3. Backup your browser profiles
        4. Save to USB/Cloud

        ## ğŸ”§ Installation

        ### Option 1: Installer (Recommended)
        - Download **L2Setup-Installer-$version.exe**
        - Run as Administrator
        - .NET 8 will be installed automatically if needed
        - Follow the installation wizard

        ### Option 2: Standalone
        - Download **L2Setup-$version.exe**
        - Requires .NET 8 Runtime (download link provided if missing)
        - Run directly (no installation)

        ## ğŸ“Š Optimizations Included

        - ğŸš€ **Performance** (9 tweaks): Background Apps, Animations, Transparency
        - ğŸ”’ **Privacy** (7 tweaks): Telemetry, Cortana, Tracking
        - ğŸ® **Gaming** (7 tweaks): Game Mode, CPU Scheduling, Nagle Algorithm
        - ğŸŒ **Network** (5 tweaks): TCP/IP, DNS, Throttling
        - ğŸ—‘ï¸ **Debloat** (7 tweaks): Remove 27 bloatware apps
        - ğŸ’¾ **Storage** (5 tweaks): SSD optimization, Indexing
        - ğŸ–¥ï¸ **CPU & Memory** (5 tweaks): Core Parking, Scheduling
        - ğŸ¨ **UI Tweaks** (7 tweaks): Context Menu, Lock Screen
        - âš¡ **Expert** (6 tweaks): OneDrive, Hibernation, UAC

        ## ğŸ†˜ Support

        - ğŸ› [Report a Bug](https://github.com/theDAVIDL2/L2-Setup/issues)
        - ğŸ’¡ [Request a Feature](https://github.com/theDAVIDL2/L2-Setup/issues)
        - ğŸ“– [Documentation](https://github.com/theDAVIDL2/L2-Setup/tree/main/docs)

        ## ğŸŒŸ Star this repo if you find it useful!

        ---

        **Made with â¤ï¸ by [L2 - theDAVIDL2](https://github.com/theDAVIDL2)**
        "@
        
        # Save to file for use in release
        $notes | Out-File -FilePath release-notes.md -Encoding UTF8
        Write-Host "âœ… Release notes generated" -ForegroundColor Green

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          release-assets/L2Setup-Installer-${{ github.ref_name }}.exe
          release-assets/L2Setup-${{ github.ref_name }}.exe
        body_path: release-notes.md
        draft: false
        prerelease: false
        generate_release_notes: false
        name: "L2 Setup ${{ github.ref_name }}"
        tag_name: ${{ github.ref_name }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Release Summary
      run: |
        Write-Host "`nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Green
        Write-Host "â•‘           âœ… RELEASE CREATED SUCCESSFULLY! âœ…              â•‘" -ForegroundColor Green
        Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`n" -ForegroundColor Green
        Write-Host "ğŸ“¦ Version: ${{ github.ref_name }}" -ForegroundColor Cyan
        Write-Host "ğŸ”— URL: https://github.com/theDAVIDL2/L2-Setup/releases/tag/${{ github.ref_name }}" -ForegroundColor Yellow
        Write-Host "`nâœ… Assets uploaded:" -ForegroundColor Green
        Write-Host "   â€¢ L2Setup-Installer-${{ github.ref_name }}.exe" -ForegroundColor White
        Write-Host "   â€¢ L2Setup-${{ github.ref_name }}.exe" -ForegroundColor White
        Write-Host "`nğŸ‰ Release is now live!" -ForegroundColor Green
